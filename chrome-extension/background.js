// Generated by CoffeeScript 1.8.0
var auth, ref, setupTabs;

ref = new Firebase("https://browse-together.firebaseio.com");

setupTabs = function(authData) {
  ref.child("users/" + authData.uid + "/tabs").onDisconnect().remove();
  return chrome.tabs.query({}, function(tabs) {
    var new_tab_data, tab, _i, _len;
    new_tab_data = {};
    for (_i = 0, _len = tabs.length; _i < _len; _i++) {
      tab = tabs[_i];
      new_tab_data[tab.id] = {
        highlighted: tab.highlighted || false,
        icon: tab.favIconUrl || '',
        title: tab.title || 'unkown',
        url: tab.url
      };
    }
    return ref.child("users/" + authData.uid + "/tabs").set(new_tab_data, function() {
      return ref.child("users").on('value', function(doc) {
        chrome.browserAction.setIcon({
          path: "icon2.png"
        });
        chrome.browserAction.setBadgeText({
          text: 'on'
        });
        return chrome.runtime.sendMessage(doc.val() || {});
      });
    });
  });
};

auth = localStorage.getItem('auth');

chrome.browserAction.setBadgeText({
  text: 'off'
});

if (auth) {
  ref.authWithCustomToken(auth, function(err, authData) {
    if (err) {
      return localStorage.removeItem('auth');
    } else {
      return setupTabs(authData);
    }
  });
}

chrome.runtime.onMessageExternal.addListener(function(request, sender, sendResponse) {
  localStorage.setItem('auth', request.token);
  return ref.authWithCustomToken(request.token, function(err, authData) {
    var user_blob;
    if (!authData) {
      return;
    }
    user_blob = {};
    switch (request.provider) {
      case 'google':
        user_blob.name = request.google.displayName;
        user_blob.image = request.google.profileImageURL;
        user_blob.last_modified = Date.now();
        break;
      case 'github':
        user_blob.name = request.github.displayName;
        user_blob.image = request.github.profileImageURL;
        user_blob.last_modified = Date.now();
    }
    ref.child("users/" + authData.uid + "/profile").set(user_blob);
    return setupTabs(authData);
  });
});

chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
  var authData;
  switch (request.type) {
    case 'get-local-user':
      authData = ref.getAuth();
      if (!authData) {
        return sendResponse(false);
      }
      ref.child("users/" + authData.uid + "/profile").once('value', function(doc) {
        return sendResponse(doc.val() || false);
      });
      break;
    case 'logout':
      authData = ref.getAuth();
      if (!authData) {
        return sendResponse(false);
      }
      ref.child("users/" + authData.uid).remove();
      ref.child("users").off('value');
      chrome.browserAction.setIcon({
        path: "icon.png"
      });
      chrome.browserAction.setBadgeText({
        text: 'off'
      });
      localStorage.removeItem('auth');
      ref.unauth();
      break;
    case 'messages':
      authData = ref.getAuth();
      if (!authData) {
        return sendResponse(false);
      }
      ref.child("users").once('value', function(doc) {
        return sendResponse(doc.val() || {});
      });
  }
  return true;
});

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
  var authData;
  if (changeInfo.status !== 'complete') {
    return;
  }
  authData = ref.getAuth();
  if (!authData) {
    return;
  }
  ref.child("users/" + authData.uid + "/tabs/" + tabId).set({
    highlighted: tab.highlighted || false,
    icon: tab.favIconUrl || '',
    title: tab.title || 'unkown',
    url: tab.url
  });
  return ref.child("users/" + authData.uid + "/profile/last_modified").set(Date.now());
});

chrome.tabs.onRemoved.addListener(function(tabId, changeInfo, tab) {
  var authData;
  authData = ref.getAuth();
  if (!authData) {
    return;
  }
  ref.child("users/" + authData.uid + "/tabs/" + tabId).remove();
  return ref.child("users/" + authData.uid + "/profile/last_modified").set(Date.now());
});

chrome.tabs.onReplaced.addListener(function(new_tab_id, remove_tab_id) {
  var authData;
  authData = ref.getAuth();
  if (!authData) {
    return;
  }
  return ref.child("users/" + authData.uid + "/tabs/" + remove_tab_id).once('value', function(obj) {
    ref.child("users/" + authData.uid + "/tabs/" + new_tab_id).set(obj.val());
    ref.child("users/" + authData.uid + "/tabs/" + remove_tab_id).remove();
    return ref.child("users/" + authData.uid + "/profile/last_modified").set(Date.now());
  });
});

chrome.tabs.onActivated.addListener(function(_arg) {
  var authData, tabId, windowId;
  tabId = _arg.tabId, windowId = _arg.windowId;
  authData = ref.getAuth();
  if (!authData) {
    return;
  }
  return chrome.tabs.getAllInWindow(windowId, function(arr) {
    var tab, _i, _len, _ref, _results;
    _ref = arr || [];
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      tab = _ref[_i];
      _results.push((function(tab) {
        return ref.child("users/" + authData.uid + "/tabs/" + tab.id).once('value', function(obj) {
          if (!(obj != null ? obj.val() : void 0)) {
            return;
          }
          ref.child("users/" + authData.uid + "/tabs/" + tab.id + "/highlighted").set(tab.highlighted);
          return ref.child("users/" + authData.uid + "/profile/last_modified").set(Date.now());
        });
      })(tab));
    }
    return _results;
  });
});

// Generated by CoffeeScript 1.8.0
var timeout;

timeout = null;

document.addEventListener('DOMContentLoaded', function() {
  return chrome.runtime.sendMessage({
    type: 'get-local-user'
  }, function(data) {
    var logged_in, processMessages;
    logged_in = Boolean(data);
    if (logged_in) {
      $('body').html(teacup.render(function() {
        div('.header', function() {
          img('.image');
          span(function() {
            return "Logged in as ";
          });
          span('.name', function() {
            return '';
          });
          return span('.logout', function() {
            return 'logout';
          });
        });
        return div('.users', function() {
          return div(function() {
            return 'Loading...';
          });
        });
      }));
      $('body .header > .name').text(data.name);
      $('body .header > .image').attr('src', data.image);
      $('.logout').on('click', function(e) {
        return chrome.runtime.sendMessage({
          type: 'logout'
        }, function(data) {
          return location.reload();
        });
      });
      processMessages = function(users) {
        clearTimeout(timeout);
        return timeout = setTimeout((function() {
          $('.users').html(teacup.render(function() {
            var key, profile, tabs, val, _results;
            _results = [];
            for (key in users) {
              val = users[key];
              profile = val.profile, tabs = val.tabs;
              if (!Object.keys(tabs || {}).length) {
                continue;
              }
              _results.push(div('.user', {
                'data-user': key
              }, function() {
                div('.header', function() {
                  img('.image', {
                    src: profile.image
                  });
                  span('.name', function() {
                    return profile.name;
                  });
                  return time('.time', {
                    'datetime': new Date(profile.last_modified).toISOString()
                  }, function() {
                    return '';
                  });
                });
                return div('.tabs', function() {
                  var highlighted, key_t, val_t, _i, _len, _ref, _results1;
                  _ref = [true, false];
                  _results1 = [];
                  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                    highlighted = _ref[_i];
                    _results1.push((function() {
                      var _results2;
                      _results2 = [];
                      for (key_t in tabs) {
                        val_t = tabs[key_t];
                        if (val_t.highlighted !== highlighted) {
                          continue;
                        }
                        _results2.push(div('.tab', {
                          'data-highlighted': val_t.highlighted
                        }, function() {
                          val_t.icon || (val_t.icon = 'transparent.ico');
                          img('.image', {
                            src: val_t.icon
                          });
                          return span('.content', function() {
                            div('.title', function() {
                              return val_t.title;
                            });
                            return a('.link', {
                              target: '_blank',
                              href: val_t.url
                            }, function() {
                              return val_t.url;
                            });
                          });
                        }));
                      }
                      return _results2;
                    })());
                  }
                  return _results1;
                });
              }));
            }
            return _results;
          }));
          return $('time.time').timeago();
        }), 1000);
      };
      chrome.runtime.sendMessage({
        type: 'messages'
      }, function(messages) {
        return processMessages(messages);
      });
      return chrome.runtime.onMessage.addListener(function(messages, sender, sendResponse) {
        return processMessages(messages);
      });
    } else {
      $('body').html(teacup.render(function() {
        return div('.login', function() {
          return 'Click here to login and get started!';
        });
      }));
      return $('.login').on('click', function(e) {
        return window.open('https://jasongornall.github.io/browse-together/', '_blank');
      });
    }
  });
});
